{% extends "vertical.html" %}
{% load static i18n crispy_forms_tags %}

{% block title %}My Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/page-title.html' with title="My Profile" %}
{% endblock page_title %}

{% block page_content %}
<div class="row justify-content-center">
    <div class="col-xl-4 col-lg-5">
        <div class="card text-center">
            <div class="card-body">
                <div class="profile-image-container mb-2">
                    {% if current_user.profile_image %}
                    <img src="{{ current_user.profile_image }}" class="profile-image" alt="profile-image">
                    {% else %}
                    <div class="profile-initials">
                        {{ current_user.Name|default:current_user.User_ID|default:"User"|slice:":2"|upper }}
                    </div>
                    {% endif %}
                    <div class="profile-image-overlay">
                        <i class="ti ti-camera"></i>
                    </div>
                </div>
                <input type="file" id="profileImageFile" class="d-none" accept="image/*">
                <div id="profileUploadStatus" class="text-muted small mb-2"></div>

                <p class="text-muted small mb-2">Click to upload &amp; crop</p>

                <h4 class="mb-0 profile-userid">
                    {{ current_user.User_ID }}
                    {% if current_user.Role|default:""|lower == "admin" %}
                    <span class="profile-verified-inline" title="Verified Admin">
                        <i class="ti ti-check"></i>
                    </span>
                    {% endif %}
                </h4>
                <p class="text-muted mb-3">{{ current_user.Email_ID }}</p>

                <div class="text-start mt-2">
                    <h4 class="font-13 text-uppercase">Personal Info</h4>
                    <p class="text-muted mb-2 font-13"><strong>User ID :</strong> <span class="ms-2">{{ current_user.User_ID }}</span></p>
                    <p class="text-muted mb-2 font-13"><strong>Role :</strong>
                        <span class="ms-2 badge bg-primary-subtle text-primary text-uppercase">
                            {{ current_user.Role|default:"User" }}
                        </span>
                    </p>
                    <p class="text-muted mb-2 font-13"><strong>Phone :</strong> <span class="ms-2">{{ current_user.Phone|default:"-" }}</span></p>
                    <p class="text-muted mb-1 font-13"><strong>Email :</strong> <span class="ms-2">{{ current_user.Email_ID }}</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-8 col-lg-7">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title mb-3">Update Profile</h4>
                {% if request.GET.updated %}
                <div class="alert alert-success">Profile updated successfully.</div>
                {% endif %}
                <form class="form-horizontal" method="post" action="{% url 'users:profile' %}">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="id_name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="id_name" name="name"
                            value="{{ current_user.Name|default:'' }}" placeholder="Enter full name">
                    </div>

                    <div class="mb-3">
                        <label for="id_phone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="id_phone" name="phone"
                            value="{{ current_user.Phone|default:'' }}" placeholder="Enter phone number">
                    </div>

                    <div class="mb-3">
                        <label for="id_age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="id_age" name="age"
                            value="{{ current_user.Age|default:'' }}" placeholder="Enter age">
                    </div>

                    <div class="mb-3">
                        <label for="id_profile_image" class="form-label">Profile Image URL (Cloudinary)</label>
                        <input type="url" class="form-control" id="id_profile_image" name="profile_image"
                            value="{{ current_user.profile_image|default:'' }}"
                            placeholder="Paste Cloudinary image URL">
                        <small class="text-muted">If you upload via Cloudinary, paste the secure URL here.</small>
                    </div>

                    <div class="mb-3 text-end">
                        <button class="btn btn-primary" type="submit">Update Info</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="profileCropModal" tabindex="-1" aria-labelledby="profileCropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileCropModalLabel">Edit Profile Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="cropper-wrapper">
                    <img id="profileCropImage" src="" alt="Crop Image" style="max-width:100%; width:100%;">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="rotateLeftBtn">
                        <i class="ti ti-rotate-2"></i> Rotate Left
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="rotateRightBtn">
                        <i class="ti ti-rotate-clockwise-2"></i> Rotate Right
                    </button>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveCroppedBtn">
                        <i class="ti ti-check me-1"></i>Use This Photo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('profileImageFile');
        const container = document.querySelector('.profile-image-container');
        const statusEl = document.getElementById('profileUploadStatus');
        const urlInput = document.getElementById('id_profile_image');
        const cloudName = "{{ cloudinary_cloud_name|default:'' }}";
        const uploadPreset = "{{ cloudinary_upload_preset|default:'' }}";
        const signatureUrl = "{% url 'api_cloudinary_signature' %}";
        const cropModalEl = document.getElementById('profileCropModal');
        const cropImageEl = document.getElementById('profileCropImage');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const saveCroppedBtn = document.getElementById('saveCroppedBtn');
        let cropper = null;

        function showStatus(text, isError = false) {
            statusEl.textContent = text || '';
            statusEl.classList.toggle('text-danger', !!isError);
            statusEl.classList.toggle('text-muted', !isError);
        }

        function openCropModal(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                cropImageEl.src = e.target.result;
                const modal = new bootstrap.Modal(cropModalEl);
                modal.show();
            };
            reader.readAsDataURL(file);
        }

        if (container && fileInput) {
            container.addEventListener('click', () => fileInput.click());
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            openCropModal(file);
        });

        cropModalEl.addEventListener('shown.bs.modal', function () {
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(cropImageEl, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1,
                responsive: true,
                background: false
            });
        });

        cropModalEl.addEventListener('hidden.bs.modal', function () {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            fileInput.value = '';
        });

        rotateLeftBtn.addEventListener('click', () => {
            if (cropper) cropper.rotate(-90);
        });
        rotateRightBtn.addEventListener('click', () => {
            if (cropper) cropper.rotate(90);
        });

        saveCroppedBtn.addEventListener('click', async () => {
            if (!cropper) return;
            showStatus('Uploading image...');

            const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
            if (!canvas) {
                showStatus('Unable to crop image.', true);
                return;
            }

            canvas.toBlob(async (blob) => {
                try {
                    if (!cloudName) {
                        showStatus('Cloudinary is not configured. Set CLOUDINARY_CLOUD_NAME in .env.', true);
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', blob, 'profile.jpg');

                    if (uploadPreset) {
                        formData.append('upload_preset', uploadPreset);
                    } else {
                        const sigRes = await fetch(signatureUrl, { credentials: 'same-origin' });
                        const sigData = await sigRes.json();
                        if (!sigRes.ok) {
                            showStatus(sigData.error || 'Unable to get upload signature.', true);
                            return;
                        }
                        formData.append('api_key', sigData.api_key);
                        formData.append('timestamp', sigData.timestamp);
                        formData.append('signature', sigData.signature);
                    }

                    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok || !data.secure_url) {
                        showStatus(data.error?.message || 'Upload failed.', true);
                        return;
                    }

                    if (urlInput) {
                        urlInput.value = data.secure_url;
                    }

                    const existingImg = container.querySelector('img.profile-image');
                    const initials = container.querySelector('.profile-initials');
                    if (initials) initials.remove();
                    if (existingImg) {
                        existingImg.src = data.secure_url;
                    } else {
                        const img = document.createElement('img');
                        img.className = 'profile-image';
                        img.alt = 'profile-image';
                        img.src = data.secure_url;
                        container.prepend(img);
                    }

                    showStatus('Uploaded. Click Update Info to save.');
                    const modalInstance = bootstrap.Modal.getInstance(cropModalEl);
                    modalInstance.hide();
                } catch (err) {
                    showStatus('Upload failed. Please try again.', true);
                }
            }, 'image/jpeg', 0.9);
        });
    });
</script>
{% endblock %}
