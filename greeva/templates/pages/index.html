{% extends 'vertical.html' %}

{% load static %}

{% block title %}Dashboard{% endblock title %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/jsvectormap/dist/css/jsvectormap.min.css" rel="stylesheet" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<style>
    /* Sensor Cards */
    .sensor-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .sensor-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15) !important;
        z-index: 10;
    }

    .sensor-icon-wrapper {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(var(--ct-primary-rgb), 0.1);
        color: var(--ct-primary);
    }

    .cursor-grab {
        cursor: grab;
    }

    .cursor-grabbing {
        cursor: grabbing;
    }

    /* SMOOTH MODAL ANIMATIONS */
    .modal.fade .modal-dialog {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease !important;
        transform: scale(0.9) translateY(-20px);
        opacity: 0;
    }

    .modal.show .modal-dialog {
        transform: scale(1) translateY(0) !important;
        opacity: 1 !important;
    }

    .modal-backdrop.fade {
        transition: opacity 0.3s ease !important;
    }

    /* SMOOTH DROPDOWN ANIMATIONS */
    .dropdown-menu {
        transition: opacity 0.2s ease, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        transform-origin: top;
    }

    .dropdown-menu:not(.show) {
        transform: scaleY(0.95) translateY(-10px);
        opacity: 0;
    }

    .dropdown-menu.show {
        transform: scaleY(1) translateY(0);
        opacity: 1;
    }

    /* LIVE SENSOR VALUE ANIMATIONS */
    .sensor-value {
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sensor-value.updating {
        animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
            color: #20c997;
        }
    }

    /* LIQUID FILL ANIMATION FOR TEMPERATURE */
    .sensor-icon-wrapper {
        position: relative;
        overflow: hidden;
    }

    .sensor-icon-wrapper::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: linear-gradient(180deg, rgba(32, 201, 151, 0.3), rgba(32, 201, 151, 0.1));
        transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 0;
    }

    .sensor-icon-wrapper.active::before {
        height: var(--fill-height, 50%);
    }

    .sensor-icon-wrapper i {
        position: relative;
        z-index: 1;
    }

    /* SMOOTH BUTTON TRANSITIONS */
    .btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
        transform: translateY(0);
    }

    /* SMOOTH CARD TRANSITIONS */
    .card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* GPU ACCELERATION */
    .modal-dialog,
    .dropdown-menu,
    .btn,
    .card,
    .sensor-card {
        will-change: transform;
        backface-visibility: hidden;
    }
</style>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/page-title.html' with title="Dashboard" %}
{% endblock page_title %}

{% block page_content %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <span
                    class="avatar-title text-bg-success rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 48px; height: 48px;">
                    <i class="ti ti-leaf fs-3"></i>
                </span>

                <div>
                    <h3 class="mb-0 fw-bold">Smart IoT</h3>
                    <p class="mb-0 text-muted" id="live-sensor-header">
                        {% if first_device %}
                        Live Sensor Data (Device ID: <span id="active-device-id">{{ first_device.id }}</span>)
                        {% else %}
                        Real-time monitoring system
                        {% endif %}
                    </p>
                </div>
                <div class="ms-auto d-flex gap-3">
                    <div class="text-end">
                        <h4 class="mb-0">{{ total_devices }}</h4>
                        <p class="mb-0 text-muted">Total Devices</p>
                    </div>
                    <div class="text-end">
                        <h4 class="mb-0 text-success">{{ online_devices }}</h4>
                        <p class="mb-0 text-muted">Online</p>
                    </div>
                    <div class="text-end">
                        <h4 class="mb-0 text-danger">{{ offline_devices }}</h4>
                        <p class="mb-0 text-muted">Offline</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Live Sensor Data (First Device) -->
    <style>
        /* Cursor */
        .cursor-grab {
            cursor: grab;
        }

        /* Sensor Card Base */
        .sensor-card {
            transition: all 0.35s ease;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        /* Hover Effect */
        .sensor-card:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(25, 135, 84, 0.45);
            box-shadow: 0 12px 28px rgba(25, 135, 84, 0.2);
        }

        /* Icon Wrapper */
        .sensor-icon-wrapper {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(25, 135, 84, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.35s ease;
        }

        .sensor-icon-wrapper i {
            font-size: 22px;
            color: #198754;
            transition: all 0.35s ease;
        }

        /* Icon Animation */
        .sensor-card:hover .sensor-icon-wrapper {
            background: #198754;
        }

        .sensor-card:hover .sensor-icon-wrapper i {
            color: #ffffff;
            transform: scale(1.15) rotate(-8deg);
        }

        /* Chart Icon */
        .sensor-history-icon {
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .sensor-card:hover .sensor-history-icon {
            color: #198754;
            transform: scale(1.2);
        }
    </style>

    <div class="col-xl-12">
        <div class="card">
            <!-- Header -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="header-title mb-0">Live Sensor Monitor</h4>
                    <small class="text-muted">Real-time sensor status</small>
                </div>

                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#customizeSensorsModal">
                    <i class="ti ti-settings me-1"></i> Customize Sensors
                </button>
            </div>

            <!-- Body -->
            <div class="card-body">
                <div class="row g-3" id="sensor-grid">
                    {% for sensor_type, reading in latest_readings.items %}
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 sensor-col" data-sensor-type="{{ sensor_type }}">

                        <div class="card sensor-card h-100 cursor-grab" data-sensor-card
                            data-sensor-type="{{ sensor_type }}" data-sensor-name="{{ sensor_type }}"
                            data-sensor-value="{{ reading.value }}" onclick="openSensorDetail(this)">

                            <div class="card-body p-3">
                                <!-- Top -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="sensor-icon-wrapper">
                                        {% if 'Temperature' in sensor_type %}
                                        <i class="ti ti-thermometer"></i>
                                        {% elif 'Humidity' in sensor_type %}
                                        <i class="ti ti-droplet"></i>
                                        {% elif 'pH' in sensor_type %}
                                        <i class="ti ti-flask"></i>
                                        {% elif 'Light' in sensor_type %}
                                        <i class="ti ti-sun"></i>
                                        {% else %}
                                        <i class="ti ti-activity"></i>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-success-subtle text-success">Active</span>
                                </div>

                                <!-- Name -->
                                <h6 class="text-muted text-uppercase mb-1">
                                    {{ sensor_type }}
                                </h6>

                                <!-- Value -->
                                <h3 class="fw-bold mb-0">
                                    <span class="sensor-value">
                                        {{ reading.value|floatformat:1 }}
                                    </span>
                                    <small class="fs-14 text-muted">
                                        {% if 'Temperature' in sensor_type %}Â°C
                                        {% elif 'Humidity' in sensor_type %}%
                                        {% elif 'pH' in sensor_type %}pH
                                        {% elif 'Light' in sensor_type %}hrs
                                        {% else %}units{% endif %}
                                    </small>
                                </h3>

                                <!-- Footer -->
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        Updated <span class="sensor-time">just now</span>
                                    </small>
                                    <i class="ti ti-chart-dots fs-4 sensor-history-icon" title="View History"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted">
                        No sensor readings available
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <!-- Device List -->
        <div class="col-xl-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="header-title mb-0">Registered Devices</h4>
                        <p class="text-muted mb-0 small">Manage your IoT devices</p>
                    </div>
                    <div class="d-flex gap-2">
                        {% if request.session.role == 'admin' %}
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                            <i class="ti ti-plus me-1"></i>Add Device
                        </button>
                        {% endif %}
                        <a href="{% url 'pages:devices_list' %}" class="btn btn-sm btn-outline-primary">
                            <i class="ti ti-list me-1"></i>View All Devices
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Device Name</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices|slice:":5" %}
                                <tr class="device-row" data-device-id="{{ device.id }}"
                                    data-device-name="{{ device.name }}" style="cursor: pointer;">
                                    <td>
                                        <h5 class="fs-14 my-1">{{ device.name }}</h5>
                                        <span class="text-muted fs-12">{{ device.sensor_id }}</span>
                                    </td>
                                    <td>{{ device.location }}</td>
                                    <td>{{ device.get_device_type_display }}</td>
                                    <td>
                                        {% if device.status == 'online' %}
                                        <i class="ti ti-circle-filled fs-12 text-success"></i> Active
                                        {% else %}
                                        <i class="ti ti-circle-filled fs-12 text-danger"></i> Offline
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'pages:analytics' %}?device_id={{ device.id }}"
                                            class="btn btn-sm btn-primary">
                                            <i class="ti ti-chart-line me-1"></i>View Analytics
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Alerts Table -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card card-soft">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <h5 class="mb-0 fw-bold">Active Alerts</h5>
                        <small class="text-muted ms-3">Recent system notifications</small>
                        <i class="ti ti-alert-triangle ms-auto text-danger p-2 rounded-circle"
                            style="font-size:18px;"></i>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-borderless table-dense mb-0">
                            <thead>
                                <tr class="text-muted small">
                                    <th scope="col">Device</th>
                                    <th scope="col">Message</th>
                                    <th scope="col">Severity</th>
                                    <th scope="col">Timestamp</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in recent_alerts %}
                                <tr class="align-middle">
                                    <td><strong>{{ alert.rule.device.name }}</strong></td>
                                    <td>{{ alert.message }}</td>
                                    <td>
                                        {% if alert.rule.severity == 'critical' %}
                                        <span class="badge bg-danger">Critical</span>
                                        {% elif alert.rule.severity == 'warning' %}
                                        <span class="badge bg-warning text-dark">Warning</span>
                                        {% else %}
                                        <span class="badge bg-info">Info</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ alert.triggered_at|date:"Y-m-d H:i" }}</td>
                                    <td><span class="badge bg-primary">{{ alert.status|title }}</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No active alerts</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Multi-Device Selector -->




    <!-- Environment Trends & Device Health -->
    <div class="row">
        <!-- Environment Trends (7 Days) -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title mb-0">Environment Trends (7 Days)</h4>
                    <p class="text-muted mb-0">Weather data based on device location</p>
                </div>
                <div class="card-body">
                    <div id="environment-trends-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Device Health -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title mb-0">Device Health</h4>
                    <p class="text-muted mb-0">Overall system status</p>
                </div>
                <div class="card-body">
                    <div id="device-health-chart" style="height: 300px;"></div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2"
                                    style="width: 12px; height: 12px; border-radius: 50%;"></span>
                                <span>Online</span>
                            </div>
                            <strong id="health-online">{{ online_devices }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-danger me-2"
                                    style="width: 12px; height: 12px; border-radius: 50%;"></span>
                                <span>Offline</span>
                            </div>
                            <strong id="health-offline">{{ offline_devices }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-warning me-2"
                                    style="width: 12px; height: 12px; border-radius: 50%;"></span>
                                <span>Maintenance</span>
                            </div>
                            <strong id="health-maintenance">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2"
                                    style="width: 12px; height: 12px; border-radius: 50%;"></span>
                                <span>Faulty</span>
                            </div>
                            <strong id="health-faulty">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farm Locations (Map Preview) -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="header-title mb-0">Farm Locations</h4>
                        <p class="text-muted mb-0">Geographic distribution of your devices</p>
                    </div>
                    <a href="{% url 'pages:map' %}" class="btn btn-sm btn-primary">
                        <i class="ti ti-external-link me-1"></i>View Full Map
                    </a>
                </div>
                <div class="card-body p-0">
                    <div id="farm-locations-map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

</div> <!-- end row-->



<!-- Customize Sensors Modal (SINGLE SOURCE OF TRUTH) -->
<div class="modal fade" id="customizeSensorsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content"
            style="border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden;">
            <!-- Header -->
            <div class="modal-header"
                style="background: linear-gradient(135deg, #198754 0%, #157347 100%); color: white; border: none; padding: 24px 30px;">
                <div>
                    <h5 class="modal-title fw-bold mb-1">
                        <i class="ti ti-settings me-2"></i>Customize Sensor Display
                    </h5>
                    <small style="opacity: 0.9;">Select which sensors to display on your dashboard</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                <!-- Info Banner -->
                <div class="alert alert-info d-flex align-items-center mb-4"
                    style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px;">
                    <i class="ti ti-info-circle fs-4 me-3"></i>
                    <div>
                        <strong>How it works:</strong> Toggle sensors ON to show them on your dashboard. Toggle OFF to
                        hide them. Your preferences are saved automatically.
                    </div>
                </div>

                <!-- Core Sensors Section -->
                <div class="mb-4">
                    <h6 class="text-uppercase text-muted mb-3" style="font-size: 12px; letter-spacing: 0.5px;">
                        <i class="ti ti-star me-1"></i>Core Sensors (Recommended)
                    </h6>
                    <div class="row g-3">
                        <!-- Temperature -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-thermometer fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Temperature</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Monitors ambient temperature
                                                for optimal plant growth</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-temperature" checked
                                            onchange="toggleSensor('Temperature')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Humidity -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-droplet fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Humidity</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Tracks
                                                relative humidity levels in the environment</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-humidity" checked
                                            onchange="toggleSensor('Humidity')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- pH -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-flask fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">pH Level</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Measures pH level of nutrient
                                                solution</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-ph" checked
                                            onchange="toggleSensor('pH')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EC -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-bolt fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">EC (Conductivity)</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Electrical conductivity -
                                                nutrient concentration</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-ec" checked
                                            onchange="toggleSensor('EC')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Light -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-sun fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Light Hours</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Daily
                                                light exposure for photosynthesis</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-light"
                                            onchange="toggleSensor('Light')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Moisture -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-droplet-half fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Moisture</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Soil or
                                                substrate moisture level</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-moisture"
                                            onchange="toggleSensor('Moisture')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nitrogen -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-atom fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Nitrogen (N)</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Essential for leaf growth and
                                                development</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-nitrogen"
                                            onchange="toggleSensor('Nitrogen')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phosphorus -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(25,135,84,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-atom-2 fs-4 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Phosphorus (P)</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Promotes root development and
                                                flowering</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-phosphorus"
                                            onchange="toggleSensor('Phosphorus')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Sensors Section -->
                <div>
                    <h6 class="text-uppercase text-muted mb-3" style="font-size: 12px; letter-spacing: 0.5px;">
                        <i class="ti ti-adjustments me-1"></i>Advanced Sensors (Optional)
                    </h6>
                    <div class="row g-3">
                        <!-- Potassium -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-flame fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Potassium (K)</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Strengthens plant
                                                immunity</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-potassium"
                                            onchange="toggleSensor('Potassium')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Water Temp -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-temperature fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Water Temperature</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Water
                                                temp in hydroponic system</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-water-temp"
                                            onchange="toggleSensor('Water Temp')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dissolved Oxygen -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-bubble fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Dissolved Oxygen</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Critical for root
                                                health</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-dissolved-oxygen"
                                            onchange="toggleSensor('Dissolved Oxygen')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TDS -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-droplet-filled fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">TDS</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Total
                                                dissolved solids</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-tds"
                                            onchange="toggleSensor('TDS')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ORP -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-activity fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">ORP</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Water
                                                quality indicator</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-orp"
                                            onchange="toggleSensor('ORP')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CO2 -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-wind fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">COâ</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Carbon
                                                dioxide concentration</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-co2"
                                            onchange="toggleSensor('CO2')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Water Level -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-waves fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Water Level</div>
                                            <small class="text-muted"
                                                style="font-size: 11px; line-height: 1.4;">Reservoir water level</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-water-level"
                                            onchange="toggleSensor('Water Level')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Flow Rate -->
                        <div class="col-md-6">
                            <div class="sensor-toggle-card p-3 border rounded"
                                style="background: #fff; transition: all 0.3s ease; cursor: pointer;"
                                onmouseover="this.style.borderColor='#198754'; this.style.boxShadow='0 4px 12px rgba(25,135,84,0.15)'"
                                onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                                        <div
                                            style="width: 40px; height: 40px; background: rgba(108,117,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="ti ti-ripple fs-4 text-secondary"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1">Flow Rate</div>
                                            <small class="text-muted" style="font-size: 11px; line-height: 1.4;">Water
                                                flow through system</small>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                        <input class="form-check-input" type="checkbox" id="check-flow-rate"
                                            onchange="toggleSensor('Flow Rate')"
                                            style="cursor: pointer; width: 44px; height: 24px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px 30px;">
                <button type="button" class="btn btn-success w-100" data-bs-dismiss="modal"
                    style="padding: 12px; font-weight: 600;">
                    <i class="ti ti-check me-2"></i>Save Preferences
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sensor Detail Modal is now dynamically generated by dashboard-interactions-enhanced.js -->

{% endblock page_content %}

{% block extra_javascript %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/jsvectormap"></script>
<script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world-merc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world.js"></script>

<!-- Sensor Animation Library (MUST load first) -->
<script src="{% static 'js/sensor-animations.js' %}"></script>

<!-- Enhanced Dashboard Interactions (Sensor Customization & Detail Popups) -->
<script src="{% static 'js/dashboard-interactions-enhanced.js' %}"></script>

<!-- Projects Analytics Dashboard App js -->
<script src="{% static 'js/pages/dashboard.js' %}"></script>

<!-- Multi-Device Selector -->
<script src="{% static 'js/dashboard-device-selector.js' %}"></script>

<!-- Leaflet for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script id="dashboard-context" type="application/json">
    {
        "online_devices": {{ online_devices|default:0 }},
        "offline_devices": {{ offline_devices|default:0 }},
        "total_devices": {{ total_devices|default:0 }},
        "devices": [
            {% for device in devices %}
            {
                "id": "{{ device.id }}",
                "name": "{{ device.name }}",
                "status": "{{ device.status }}"
            }{% if not forloop.last %}, {% endif %}
            {% endfor %}
        ],
        "user": {
            {% if request.user.is_authenticated %}
            "name": "{{ request.user.name|default:request.user.email|default:'User' }}",
            "email": "{{ request.user.email|default:'' }}",
            "role": "{{ request.user.role|default:'user' }}"
            {% else %}
            "name": "Guest",
            "email": "",
            "role": "visitor"
            {% endif %}
        }
    }
</script>

<!-- Enabled Sensors Context (for frontend initialization) -->
<script id="enabled-sensors-context" type="application/json">
    {
        {% for sensor_name, is_enabled in enabled_sensors.items %}
        "{{ sensor_name }}": {{ is_enabled|lower }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    }
</script>

<!-- Auto-Update Sensor Script (Added by Agent) -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const POLL_INTERVAL = 5000; // 5 Seconds

        function updateSensors() {
            // Retrieve Active Device ID if present (optional)
            const deviceIdEl = document.getElementById('active-device-id');
            const deviceId = deviceIdEl ? deviceIdEl.innerText : null;

            let url = '/api/devices/sensors/latest/';
            if (deviceId && deviceId !== 'None') {
                url += `?device_id=${encodeURIComponent(deviceId)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Mapping API keys to UI labels used in template
                    const mapping = {
                        'temperature': 'Temperature',
                        'humidity': 'Humidity',
                        'ph': 'pH',
                        'ec': 'EC',
                        'tds': 'TDS',
                        'co2': 'CO2',
                        'light': 'Light',
                        'water_temp': 'Water Temp',
                        'dissolved_oxygen': 'Dissolved Oxygen'
                    };

                    Object.keys(data).forEach(key => {
                        const val = data[key];
                        if (val === null || val === undefined) return;

                        const uiType = mapping[key];
                        if (!uiType) return;

                        // Find all cards matching this type
                        // We select elements containing the specific data-sensor-type
                        // Note: The template generates `data-sensor-type="{{ sensor_type }}"`
                        // We try to match loosely (contains)

                        const cards = document.querySelectorAll(`[data-sensor-type*="${uiType}"]`);
                        cards.forEach(card => {
                            const valSpan = card.querySelector('.sensor-value');
                            if (valSpan) {
                                // Simple animation
                                valSpan.style.transition = 'opacity 0.2s';
                                valSpan.style.opacity = '0.5';
                                setTimeout(() => {
                                    valSpan.innerText = Number(val).toFixed(1);
                                    valSpan.style.opacity = '1';
                                }, 200);
                            }
                            // Update timestamp text
                            const timeSpan = card.querySelector('.sensor-time');
                            if (timeSpan) timeSpan.innerText = 'Just now';
                        });
                    });
                })
                .catch(err => console.error('Sensor poll failed', err));
        }

        // Start Polling
        setInterval(updateSensors, POLL_INTERVAL);
        // Initial call
        // setTimeout(updateSensors, 1000);
    });
</script>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addDeviceModalLabel">
                    <i class="ti ti-device-desktop-analytics me-2"></i>Add New Device
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="deviceName" name="device_name" required
                            placeholder="e.g., Greenhouse 1">
                    </div>
                    <div class="mb-3">
                        <label for="deviceLocation" class="form-label">Location <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="deviceLocation" name="location" required
                            placeholder="e.g., IIT Guwahati, Assam">
                    </div>
                    <div class="mb-3">
                        <label for="deviceType" class="form-label">Device Type <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="deviceType" name="device_type" required>
                            <option value="">Select Type</option>
                            <option value="hydroponic">Hydroponic System</option>
                            <option value="greenhouse">Greenhouse</option>
                            <option value="indoor_farm">Indoor Farm</option>
                            <option value="aquaponic">Aquaponic System</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sensorId" class="form-label">Sensor ID</label>
                        <input type="text" class="form-control" id="sensorId" name="sensor_id"
                            placeholder="e.g., SENS-001 (Optional)">
                        <small class="text-muted">Leave blank to auto-generate</small>
                    </div>
                    <div class="alert alert-info d-flex align-items-start">
                        <i class="ti ti-info-circle me-2 mt-1"></i>
                        <small>The device will be registered under your account and will appear in your dashboard once
                            activated.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitAddDevice()">
                    <i class="ti ti-check me-1"></i>Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function submitAddDevice() {
        const form = document.getElementById('addDeviceForm');
        const formData = new FormData(form);

        // Show loading state
        const submitBtn = event.target;
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';

        fetch('/hydroponics/add-device/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
                    modal.hide();

                    // Show success message
                    alert('Device added successfully!');

                    // Reload page to show new device
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to add device'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the device');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
    }
</script>

<script src="{% static 'js/dashboard-init.js' %}"></script>


{% endblock extra_javascript %}