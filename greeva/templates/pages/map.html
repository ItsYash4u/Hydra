{% extends 'vertical.html' %}
{% load static %}

{% block title %}Map Overview{% endblock title %}

{% block page_title %}
{% include 'partials/page-title.html' with title="Geographic Overview" %}
{% endblock page_title %}

{% block page_content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div id="full-map" style="height: 75vh; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Map Data passed from View (DTO) -->
{{ map_data_json|json_script:"map-data-json" }}

{% endblock page_content %}

{% block extra_javascript %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            let mapData = JSON.parse(document.getElementById('map-data-json').textContent);
            if (typeof mapData === 'string') {
                mapData = JSON.parse(mapData);
            }
            console.log("Map Data:", mapData);

            if (typeof L === 'undefined') {
                throw new Error('Leaflet L is not defined. Script failed to load.');
            }

            const lat = mapData.center_lat || 20.59;
            const lon = mapData.center_lon || 78.96;

            var map = L.map('full-map').setView([lat, lon], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const points = Array.isArray(mapData.points) ? mapData.points : [];
            points.forEach(point => {
                const color = point.status === 'Online' ? 'green' : 'red';

                const markerHtml = `
                    <div style="
                        background-color: ${color};
                        width: 15px;
                        height: 15px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5);
                    "></div>
                `;

                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: markerHtml,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([point.latitude, point.longitude], { icon: icon }).addTo(map);

                const popupContent = `
                    <div style="font-family: 'Inter', sans-serif;">
                        <h5 style="margin: 0 0 5px 0;">${point.device_id}</h5>
                        <p style="margin: 0; font-size: 12px; color: #666;">Owner: <b>${point.owner_name}</b></p>
                        <p style="margin: 5px 0 0 0; color: ${color}; font-weight: bold;">${point.status}</p>
                        <a href="/pages/analytics/?device_id=${point.device_id}" style="display: block; margin-top: 8px; font-size: 12px;">View Analytics &rarr;</a>
                    </div>
                `;

                marker.bindPopup(popupContent);

                marker.on('mouseover', function (e) {
                    this.openPopup();
                });
            });
            console.log("✅ Map initialized successfully");
        } catch (e) {
            console.error("❌ Map initialization error:", e);
        }
    });
</script>
{% endblock extra_javascript %}
