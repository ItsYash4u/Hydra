{% extends 'vertical.html' %}
{% load static %}

{% block title %}Services & Operations{% endblock title %}

{% block page_title %}
{% include 'partials/page-title.html' with title="Services & Operations" %}
{% endblock page_title %}

{% block page_content %}

<!-- Top Stats Row -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <span class="text-bg-primary rounded-circle d-inline-flex justify-content-center align-items-center"
                    style="width: 40px; height: 40px;">
                    <i class="ti ti-briefcase fs-3"></i>
                </span>

                <div>
                    <h3 class="mb-0 fw-bold">System Operations</h3>
                    <p class="mb-0 text-muted">Manage devices and maintenance</p>
                </div>
                <div class="ms-auto d-flex gap-3">
                    <div class="text-end">
                        <h4 class="mb-0">{{ total_devices }}</h4>
                        <p class="mb-0 text-muted">Total Devices</p>
                    </div>
                    <div class="text-end">
                        <h4 class="fw-bold text-warning mb-0">{{ maintenance_devices }}</h4>
                        <p class="mb-0 text-muted">In Maintenance</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <!-- Registered Devices -->
    <div class="col-xl-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="header-title">Registered Devices</h4>
                <button class="btn btn-sm btn-outline-primary"><i class="ti ti-plus"></i> Add Device</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Device Name</th>
                                <th>Location</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <td>
                                    <h5 class="fs-14 my-1">{{ device.device_id }}</h5>
                                </td>
                                <td>{{ device.latitude|default:"--" }}, {{ device.longitude|default:"--" }}</td>
                                <td>Hydroponics Unit</td>
                                <td>
                                    <!-- Simple Online Status Assumption -->
                                    <span class="badge bg-success-subtle text-success">Online</span>
                                </td>
                                <td>
                                    <a href="{% url 'pages:device_detail' device.pk %}"
                                        class="btn btn-sm btn-soft-info"><i class="ti ti-settings"></i> Manage</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No devices found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Health Chart -->
    <div class="col-xl-4">
        <div class="card h-100">
            <div class="card-header">
                <h4 class="header-title">Fleet Health</h4>
            </div>
            <div class="card-body">
                <div id="health-chart" class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>
</div>

<!-- Maintenance Logs -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="header-title">Recent Maintenance Logs</h4>
            </div>
            <div class="table-responsive">
                <table class="table table-centered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Device</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Technician</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in maintenance_logs %}
                        <tr>
                            <td>{{ log.performed_at|date:"M d, Y" }}</td>
                            <td>{{ log.device.name }}</td>
                            <td><span class="badge bg-secondary">{{ log.maintenance_type|title }}</span></td>
                            <td>{{ log.description }}</td>
                            <td>{{ log.performed_by.name|default:"System" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="ti ti-clipboard-check fs-2 d-block mb-2"></i>
                                No maintenance records found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Alerts -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card card-soft">
            <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                    <h5 class="mb-0 fw-bold">Active System Alerts</h5>
                    <i class="ti ti-bell-ringing ms-auto text-warning p-2" style="font-size:18px;"></i>
                </div>

                <div class="table-responsive">
                    <table class="table table-borderless table-dense mb-0">
                        <thead>
                            <tr class="text-muted small">
                                <th scope="col">Device</th>
                                <th scope="col">Message</th>
                                <th scope="col">Severity</th>
                                <th scope="col">Timestamp</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in recent_alerts %}
                            <tr class="align-middle">
                                <td><strong>{{ alert.rule.device.name }}</strong></td>
                                <td>{{ alert.message }}</td>
                                <td>
                                    {% if alert.rule.severity == 'critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                    {% elif alert.rule.severity == 'warning' %}
                                    <span class="badge bg-warning text-dark">Warning</span>
                                    {% else %}
                                    <span class="badge bg-info">Info</span>
                                    {% endif %}
                                </td>
                                <td>{{ alert.triggered_at|date:"Y-m-d H:i" }}</td>
                                <td><span class="badge bg-primary">{{ alert.status|title }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No active alerts</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

{{ chart_data.health_series|json_script:"health-data" }}

{% endblock page_content %}

{% block extra_javascript %}
<script src="{% static '/vendor/apexcharts/apexcharts.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var healthData = JSON.parse(document.getElementById('health-data').textContent);

        var healthOptions = {
            chart: { type: 'donut', height: 300 },
            series: healthData,
            labels: ['Online', 'Offline', 'Maintenance', 'Faulty'],
            colors: ['#0acf97', '#fa5c7c', '#ffbc00', '#39afd1'],
            legend: { position: 'bottom' }
        };
        new ApexCharts(document.querySelector("#health-chart"), healthOptions).render();
    });
</script>
{% endblock extra_javascript %}